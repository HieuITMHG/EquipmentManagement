{% extends "manager/layout.html" %}

{% block manager_content %}
<div class="flex flex-col min-h-screen p-6 bg-gray-50">
    <div class="flex-grow w-full max-w-3xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Chỉnh Sửa Phiếu Kiểm Kê</h1>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="bg-{{ 'green' if category == 'success' else 'red' }}-100 border border-{{ 'green' if category == 'success' else 'red' }}-400 text-{{ 'green' if category == 'success' else 'red' }}-700 px-4 py-3 rounded relative mb-4" role="alert">
                        <span class="block sm:inline">{{ message }}</span>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Form -->
        <form method="POST" action="/inventory/edit_form/{{ phieu_kiem_ke_id }}" class="bg-white p-6 rounded-lg shadow-md">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2" for="staff_id">ID Nhân Viên</label>
                    <input type="text" id="staff_id" name="staff_id" value="{{ inventory.nhan_vien_id }}" readonly class="w-full border border-gray-300 rounded-lg p-2 bg-gray-100">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2" for="start_date">Ngày Bắt Đầu</label>
                    <input type="datetime-local" id="start_date" name="start_date" value="{{ inventory.start_date }}" required class="w-full border border-gray-300 rounded-lg p-2">
                </div>
                <div>
                    <label class="block text-gray-700 font-semibold mb-2" for="end_date">Ngày Kết Thúc</label>
                    <input type="datetime-local" id="end_date" name="end_date" value="{{ inventory.end_date }}" required class="w-full border border-gray-300 rounded-lg p-2">
                </div>
            </div>

            <!-- Room Details -->
            <h2 class="text-xl font-semibold text-gray-800 mt-6 mb-4">Chi Tiết Phòng</h2>
            <div class="space-y-4 max-h-[calc(100vh-400px)] overflow-y-auto pr-2">
                {% for room in rooms %}
                <div class="p-4 border border-gray-200 rounded-lg">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Phòng {{ room.id }}</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-600 mb-1" for="total_devices_{{ room.id }}">Tổng Số Lượng</label>
                            <input type="number" id="total_devices_{{ room.id }}" name="total_devices_{{ room.id }}" min="0" required
                                   value="{{ room_details | selectattr('room_id', 'equalto', room.id) | map(attribute='total_devices') | first | default(0) }}"
                                   class="w-full border border-gray-300 rounded-lg p-2">
                        </div>
                        <div>
                            <label class="block text-gray-600 mb-1" for="broken_count_{{ room.id }}">Số Lượng Hỏng</label>
                            <input type="number" id="broken_count_{{ room.id }}" name="broken_count_{{ room.id }}" min="0" required
                                   value="{{ room_details | selectattr('room_id', 'equalto', room.id) | map(attribute='broken_count') | first | default(0) }}"
                                   class="w-full border border-gray-300 rounded-lg p-2">
                        </div>
                        <div>
                            <label class="block text-gray-600 mb-1" for="repairing_count_{{ room.id }}">Số Lượng Đang Sửa Chữa</label>
                            <input type="number" id="repairing_count_{{ room.id }}" name="repairing_count_{{ room.id }}" min="0" required
                                   value="{{ room_details | selectattr('room_id', 'equalto', room.id) | map(attribute='repairing_count') | first | default(0) }}"
                                   class="w-full border border-gray-300 rounded-lg p-2">
                        </div>
                        <div>
                            <label class="block text-gray-600 mb-1" for="liquidated_count_{{ room.id }}">Số Lượng Đã Thanh Lý</label>
                            <input type="number" id="liquidated_count_{{ room.id }}" name="liquidated_count_{{ room.id }}" min="0" required
                                   value="{{ room_details | selectattr('room_id', 'equalto', room.id) | map(attribute='liquidated_count') | first | default(0) }}"
                                   class="w-full border border-gray-300 rounded-lg p-2">
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Buttons -->
            <div class="mt-6 flex flex-wrap gap-4 sticky bottom-0 bg-white py-4">
                <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 transition duration-200">Cập Nhật Phiếu Kiểm Kê</button>
                <a href="/inventory/inventory_history" class="bg-gray-600 text-white px-4 py-2 rounded-lg shadow hover:bg-gray-700 transition duration-200">Quay lại</a>
                <a href="/inventory/inventory_history" class="text-blue-600 hover:underline flex items-center">Hủy</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}